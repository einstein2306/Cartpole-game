<!DOCTYPE html>
<html lang="en">
<head>
    <link href="/static/css/usermode.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UserMode</title>
</head>
<body>
    <h2>CartPole UserMode</h2>
    <button class="btn btn-primary" id="startBtn" onclick="startGame()">Start</button>
    <button class="btn btn-danger" id="stopBtn" onclick="stopGame()" style="display: none;">Stop</button>
    <div class="score">Score: <span id="score">0</span></div>
    <div class="game-container">
        <div id="cart-container">
            <div class="cart">
                <div class="pivot-point"></div>
                <div class="pole" id="pole"></div>
            </div>
        </div>
        <div class="ground"></div>
        <div class="game-over" id="gameOver">
            Game Over!
            <br>
            <button class="reset-btn" onclick="resetGame()">Play Again</button>
        </div>
    </div>

    <div class="controls">
        <button class="control-btn" id="leftBtn" onclick="moveCart('left')" disabled>
            ← Left
        </button>
        <button class="control-btn" id="rightBtn" onclick="moveCart('right')" disabled>
            Right →
        </button>
    </div>

    <script>
        let cartPosition = 400;
        let score = 0;
        let poleAngle = 0;
        let poleVelocity = 0;
        let isGameOver = false;
        let isGameRunning = false;
        const cartContainer = document.getElementById('cart-container');
        const scoreElement = document.getElementById('score');
        const pole = document.getElementById('pole');
        const gameOverElement = document.getElementById('gameOver');
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');

        function updatePole() {
            if (isGameOver || !isGameRunning) return;

            const gravity = 0.12;
            const damping = 0.995;
            const randomForce = (Math.random() - 0.5) * 0.05;

            poleVelocity += (gravity * Math.sin(poleAngle * Math.PI / 180)) + randomForce;
            poleVelocity *= damping;
            poleAngle += poleVelocity;

            // Check for fall (90 degrees in either direction)
            if (Math.abs(poleAngle) > 90) {
                gameOver();
                return;
            }

            pole.style.transform = `rotate(${poleAngle}deg)`;
            requestAnimationFrame(updatePole);
        }

        function moveCart(direction) {
            if (isGameOver || !isGameRunning) return;

            const moveAmount = direction === 'left' ? -20 : 20;
            cartPosition += moveAmount;

            // Boundary check
            if (cartPosition < 100 || cartPosition > 700) {
                gameOver();
                return;
            }

            cartContainer.style.left = cartPosition + 'px';

            // Add force to pole in opposite direction
            poleVelocity += direction === 'left' ? 0.4 : -0.4;

            score += 1;
            scoreElement.textContent = score;
        }

        function gameOver() {
            isGameOver = true;
            isGameRunning = false;
            gameOverElement.style.display = 'block';
            leftBtn.disabled = true;
            rightBtn.disabled = true;
            stopBtn.style.display = 'none';
        }

        function resetGame() {
            isGameOver = false;
            cartPosition = 400;
            poleAngle = 0;
            poleVelocity = 0;
            score = 0;

            cartContainer.style.left = cartPosition + 'px';
            pole.style.transform = 'rotate(0deg)';
            gameOverElement.style.display = 'none';
            scoreElement.textContent = '0';
            leftBtn.disabled = false;
            rightBtn.disabled = false;

            // Automatically start the game after resetting
            isGameRunning = true;
            stopBtn.style.display = 'block';
            updatePole();
        }

        function startGame() {
            isGameRunning = true;
            startBtn.style.display = 'none';
            stopBtn.style.display = 'block';
            leftBtn.disabled = false;
            rightBtn.disabled = false;
            updatePole();
        }

        function stopGame() {
            isGameRunning = false;
            stopBtn.style.display = 'none';
            startBtn.style.display = 'block';
            leftBtn.disabled = true;
            rightBtn.disabled = true;
        }

        // Add keyboard controls
        document.addEventListener('keydown', (e) => {
            if (isGameOver || !isGameRunning) return;
            if (e.key === 'ArrowLeft') moveCart('left');
            if (e.key === 'ArrowRight') moveCart('right');
        });
    </script>
</body>
</html>